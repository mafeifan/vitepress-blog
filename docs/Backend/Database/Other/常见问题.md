## 关于在最后一秒支付的业务逻辑问题

问：我有一个需求，比如说有一个商品，用户下单后 (还未支付), 我先锁定改商品，10 分钟未支付就还原状态，但是用户在 9 分 59 秒的时候支付了，此时商品还原队列优先执行了，把商品设置为了正常状态并把订单设置为过期，然后支付回调检测到订单过期了，肯定不能正常下单了，这种业务逻辑改如何优化？

答：

1. 订单过期 20 分钟，第三方订单过期 19 分钟，1 分钟时间差，避开就好～，其实也不用差 1 分钟这么久….😂
2. 这个简单，像微信支付，在预支付订单接口可以传订单交易结束时间，这个时间设置为订单过期时间，超过时间无法支付


## 订单如何避免重复支付？
问：客户端 A 拉起微信支付，客户端 B 拉起支付宝支付，这个时候 张三同时进行输入支付密码支付，考虑 支付宝亦或是微信回调到服务端有可能失败。会多次回调服务端
或者说 回调处理完了订单 没有返回 微信或者支付 成功 或者说 正在处理中，在这样的一个场景下 应该如何避免这样的问题发生

答：

1. 使用laravel的[锁管理](https://learnku.com/docs/laravel/8.x/cache/9389#lock-driver-prerequisites)
2. 支付回调发现已经支付了，做退款处理即可，你可以用锁或者其他限制在发起支付限制一下，但是无法完全限制，所以后备方案就是退款处理
3. 购物车 -》订单 加一个锁 这个时间很短，比如说 10 秒没有完成，就解锁，退回购物车。 订单 -》支付 加一个锁，这个时间比较长，比如说 30 分钟。如果没有支付完成，解锁，同时将订单设为一取消状态。如果用户要重新支付，就要重新下单。
